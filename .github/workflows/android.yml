name: Android Build & Deploy

on:
    push:
        branches: ["main"]
    workflow_dispatch:

jobs:
    build_and_deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"
                  cache: gradle

            - name: Check required secrets
              id: secrets
              env:
                  FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
                  FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
                  GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
                  KEYSTORE_FILE_BASE64: ${{ secrets.KEYSTORE_FILE_BASE64 }}
                  KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
                  KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
                  KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
              run: |
                  debug_ready=true
                  [ -z "$FIREBASE_APP_ID" ] && debug_ready=false
                  [ -z "$FIREBASE_SERVICE_ACCOUNT_JSON" ] && debug_ready=false

                  release_ready=$debug_ready
                  [ -z "$KEYSTORE_FILE_BASE64" ] && release_ready=false
                  [ -z "$KEYSTORE_PASSWORD" ] && release_ready=false
                  [ -z "$KEY_PASSWORD" ] && release_ready=false
                  [ -z "$KEY_ALIAS" ] && release_ready=false

                  google_services_present=true
                  [ -z "$GOOGLE_SERVICES_JSON_BASE64" ] && google_services_present=false

                  fallback_ready=true
                  [ ! -f "app/google-services.json" ] && fallback_ready=false
                  [ ! -f "keystore-base64.txt" ] && fallback_ready=false

                  missing=""
                  [ -z "$FIREBASE_APP_ID" ] && missing="$missing\nFIREBASE_APP_ID"
                  [ -z "$FIREBASE_SERVICE_ACCOUNT_JSON" ] && missing="$missing\nFIREBASE_SERVICE_ACCOUNT_JSON"
                  [ -z "$GOOGLE_SERVICES_JSON_BASE64" ] && missing="$missing\nGOOGLE_SERVICES_JSON_BASE64"
                  [ -z "$KEYSTORE_FILE_BASE64" ] && missing="$missing\nKEYSTORE_FILE_BASE64"
                  [ -z "$KEYSTORE_PASSWORD" ] && missing="$missing\nKEYSTORE_PASSWORD"
                  [ -z "$KEY_PASSWORD" ] && missing="$missing\nKEY_PASSWORD"
                  [ -z "$KEY_ALIAS" ] && missing="$missing\nKEY_ALIAS"

                  echo "debug_ready=$debug_ready" >> "$GITHUB_OUTPUT"
                  echo "release_ready=$release_ready" >> "$GITHUB_OUTPUT"
                  echo "google_services_present=$google_services_present" >> "$GITHUB_OUTPUT"
                  echo "fallback_ready=$fallback_ready" >> "$GITHUB_OUTPUT"
                  echo "Debug deploy ready: $debug_ready"
                  echo "Release deploy ready: $release_ready"
                  echo "Google services provided: $google_services_present"
                  echo "Fallback ready (files in repo): $fallback_ready"
                  echo "Missing secrets:${missing}" 
                  if [ -n "$missing" ]; then
                    echo "### Missing GitHub Secrets" >> "$GITHUB_STEP_SUMMARY"
                    echo "$missing" >> "$GITHUB_STEP_SUMMARY"
                  fi

            # 1. Decode the Keystore File (Required for Release Build)
            - name: Decode Keystore
              if: ${{ steps.secrets.outputs.release_ready == 'true' }}
              env:
                  ENCODED_STRING: ${{ secrets.KEYSTORE_FILE_BASE64 }}
              run: |
                  if [ ! -z "$ENCODED_STRING" ]; then
                    echo $ENCODED_STRING | base64 -di > release.keystore
                    echo "Keystore decoded successfully."
                  else
                    echo "Warning: KEYSTORE_FILE_BASE64 secret not found. Release build signing will fail."
                  fi

            - name: Decode Keystore (fallback from repository file)
              if: ${{ steps.secrets.outputs.release_ready != 'true' && steps.secrets.outputs.fallback_ready == 'true' }}
              run: |
                  ENCODED_STRING=$(cat keystore-base64.txt)
                  echo "$ENCODED_STRING" | base64 -di > release.keystore
                  echo "Keystore decoded from repository base64."

            # 2. Create keystore.properties (Used by build.gradle.kts)
            - name: Create keystore.properties
              if: ${{ steps.secrets.outputs.release_ready == 'true' }}
              run: |
                  echo "storeFile=../release.keystore" > keystore.properties
                  echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> keystore.properties
                  echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> keystore.properties
                  echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> keystore.properties

            - name: Create keystore.properties (fallback)
              if: ${{ steps.secrets.outputs.release_ready != 'true' && steps.secrets.outputs.fallback_ready == 'true' }}
              run: |
                  echo "storeFile=../release.keystore" > keystore.properties
                  echo "keyAlias=payc" >> keystore.properties
                  echo "storePassword=payc2025" >> keystore.properties
                  echo "keyPassword=payc2025" >> keystore.properties

            # 3. Decode google-services.json
            - name: Create google-services.json
              if: ${{ steps.secrets.outputs.google_services_present == 'true' }}
              env:
                  GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
              run: |
                  echo $GOOGLE_SERVICES_JSON | base64 -di > app/google-services.json
                  echo "google-services.json created successfully."

            - name: Grant execute permission for gradlew
              run: chmod +x gradlew

            # 4. Build Both APKs
            - name: Build Debug APK
              run: ./gradlew assembleDebug --stacktrace

            - name: Build Release APK
              run: ./gradlew assembleRelease --stacktrace

            # 5. Upload Debug APK to Firebase
            - name: Upload Debug APK
              if: ${{ steps.secrets.outputs.debug_ready == 'true' }}
              uses: wzieba/Firebase-Distribution-Github-Action@v1
              with:
                  appId: ${{ secrets.FIREBASE_APP_ID }}
                  serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
                  groups: testers
                  file: app/build/outputs/apk/debug/app-debug.apk
                  releaseNotes: "Debug Build - Commit: ${{ github.sha }}"

            - name: Upload Debug APK (fallback)
              if: ${{ steps.secrets.outputs.debug_ready != 'true' && steps.secrets.outputs.fallback_ready == 'true' }}
              uses: wzieba/Firebase-Distribution-Github-Action@v1
              with:
                  appId: 1:611955759822:android:1059bf9af9468b725bce9f
                  serviceCredentialsFile: app/google-services.json
                  groups: testers
                  file: app/build/outputs/apk/debug/app-debug.apk
                  releaseNotes: "Debug Build (fallback creds) - Commit: ${{ github.sha }}"

            # 6. Upload Release APK to Firebase
            - name: Upload Release APK
              if: ${{ steps.secrets.outputs.release_ready == 'true' }}
              uses: wzieba/Firebase-Distribution-Github-Action@v1
              with:
                  appId: ${{ secrets.FIREBASE_APP_ID }}
                  serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
                  groups: testers
                  file: app/build/outputs/apk/release/app-release.apk
                  releaseNotes: "Release Build - Commit: ${{ github.sha }}"

            - name: Upload Release APK (fallback)
              if: ${{ steps.secrets.outputs.release_ready != 'true' && steps.secrets.outputs.fallback_ready == 'true' }}
              uses: wzieba/Firebase-Distribution-Github-Action@v1
              with:
                  appId: 1:611955759822:android:1059bf9af9468b725bce9f
                  serviceCredentialsFile: app/google-services.json
                  groups: testers
                  file: app/build/outputs/apk/release/app-release.apk
                  releaseNotes: "Release Build (fallback creds) - Commit: ${{ github.sha }}"

            - name: Job summary
              run: |
                  echo "### Android CI Summary" >> "$GITHUB_STEP_SUMMARY"
                  echo "- Debug deploy ready: ${{ steps.secrets.outputs.debug_ready }}" >> "$GITHUB_STEP_SUMMARY"
                  echo "- Release deploy ready: ${{ steps.secrets.outputs.release_ready }}" >> "$GITHUB_STEP_SUMMARY"
                  echo "- Google services provided: ${{ steps.secrets.outputs.google_services_present }}" >> "$GITHUB_STEP_SUMMARY"
                  echo "- Fallback ready: ${{ steps.secrets.outputs.fallback_ready }}" >> "$GITHUB_STEP_SUMMARY"
