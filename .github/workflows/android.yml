name: Android Build & Deploy

on:
    push:
        branches: ["main"]
    workflow_dispatch:

jobs:
    build_and_deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"
                  cache: gradle

            - name: Validate required secrets
              run: |
                  missing=0
                  for s in FIREBASE_APP_ID FIREBASE_SERVICE_ACCOUNT_JSON GOOGLE_SERVICES_JSON_BASE64 KEYSTORE_FILE_BASE64 KEYSTORE_PASSWORD KEY_PASSWORD KEY_ALIAS; do
                    v=$(printenv $s)
                    if [ -z "$v" ]; then
                      echo "Missing secret: $s"
                      missing=1
                    fi
                  done
                  if [ $missing -eq 1 ]; then
                    echo "One or more required secrets are missing"
                    exit 1
                  fi

            # 1. Decode the Keystore File (Required for Release Build)
            - name: Decode Keystore
              env:
                  ENCODED_STRING: ${{ secrets.KEYSTORE_FILE_BASE64 }}
              run: |
                  if [ ! -z "$ENCODED_STRING" ]; then
                    echo $ENCODED_STRING | base64 -di > release.keystore
                    echo "Keystore decoded successfully."
                  else
                    echo "Warning: KEYSTORE_FILE_BASE64 secret not found. Release build signing will fail."
                  fi

            # 2. Create keystore.properties (Used by build.gradle.kts)
            - name: Create keystore.properties
              run: |
                  echo "storeFile=../release.keystore" > keystore.properties
                  echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> keystore.properties
                  echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> keystore.properties
                  echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> keystore.properties

            # 3. Decode google-services.json
            - name: Create google-services.json
              env:
                  GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
              run: |
                  if [ ! -z "$GOOGLE_SERVICES_JSON" ]; then
                    echo $GOOGLE_SERVICES_JSON | base64 -di > app/google-services.json
                    echo "google-services.json created successfully."
                  else
                    echo "Warning: GOOGLE_SERVICES_JSON_BASE64 secret not found. Build may fail."
                  fi

            - name: Grant execute permission for gradlew
              run: chmod +x gradlew

            # 4. Build Both APKs
            - name: Build Debug APK
              run: ./gradlew assembleDebug --stacktrace

            - name: Build Release APK
              run: ./gradlew assembleRelease --stacktrace

            # 5. Upload Debug APK to Firebase
            - name: Upload Debug APK
              uses: wzieba/Firebase-Distribution-Github-Action@v1
              with:
                  appId: ${{ secrets.FIREBASE_APP_ID }}
                  serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
                  groups: testers
                  file: app/build/outputs/apk/debug/app-debug.apk
                  releaseNotes: "Debug Build - Commit: ${{ github.sha }}"

            # 6. Upload Release APK to Firebase
            - name: Upload Release APK
              uses: wzieba/Firebase-Distribution-Github-Action@v1
              with:
                  appId: ${{ secrets.FIREBASE_APP_ID }}
                  serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
                  groups: testers
                  file: app/build/outputs/apk/release/app-release.apk
                  releaseNotes: "Release Build - Commit: ${{ github.sha }}"
